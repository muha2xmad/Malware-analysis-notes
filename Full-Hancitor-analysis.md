As-salamu Alaykum

Notes of the full Hancitor malware analysis from this [article](https://muha2xmad.github.io/malware-analysis/fullHancitor/).

# Unpacking 
We try to identify the given sample we see it's packed. Then Unpack the sample using `x32dbg`. Using two methodes [1](https://muha2xmad.github.io/unpacking/hancitor/) or [2](https://muha2xmad.github.io/malware-analysis/fullHancitor/#unpacking-process)

# Abnormal EntryPoint
there are 3 exports `BNJAFSRSQIX`, `SDTECHWMHHONG`, `DllEntryPoint`. The EntryPoint is `BNJAFSRSQIX` **Not** `DllEntryPoint`.

# Gathering victim information

The malware tries to collect information about the victim host and make a unique ID to identify and decide the next stage of the malware. The collected info is: OS version, Computer name, Domains names, Victim IP address, whether the machine is x64 or x86 OS.
Then send it to the C2 server to get the response of what to do next.

# Configuration Extraction

The Configuration is located at the beginning of `.data` section. First, the malware will decrypt the encrypted Configuration. 

How the decryption happens?

1. Decrypt `Pbdata` which in SHA1 encryption. `Pbdata` acts as Key
2. Then use the first 5 bytes for decrypting the RC4-encrypted function `byte_10005018`. After that we get the decrypted C2 servers and build ID.

# C2 server Communication

Here are the steps which indicated how the malware will do after. Sending the collected info and get the response 

The command contains: 

```
 A specific action from  this set `{'b','e','l','n','r'}`

 A colon (:) char

 A URL is used to download malicious content
```

# Download content and inject

Based on the response of the C2 server the malware will decide how to operate:

`b` action: The downloaded content will be injected into a new `svchost.exe`

`e`action: The downloaded content will be injected into the current running process.

`i` action: Downloads shellcode and inject it into the current process or into `svchost.exe`.

`n` action: Does nothing, or itâ€™s used to ping the victim.

`r` action: Drop an EXE or DLL in the Temp folder then inject into `svchost.exe`.


# IoCs

We analyze the malwares to gain knowledge and get IoCs and add rules to the firewalls to detect the malware. You can see the IoCs from [Here](https://muha2xmad.github.io/malware-analysis/fullHancitor/#iocs).

