# About Dridex
 The APT known as TA505, anti-analysis techniques,  API hashing with VEH (Vectored Exception Handling) manipulation. 

 uses API hashing to get its imports

 using CRC32 hashing + layer of XORing with hard-coded key

# Analysis
## API hashing

API hashing: the malware will hase the names of its imports table and will resolve the needed functions only on the fly- in memory-

To spot API hashing techniques, is to look for a function which takes constant (random-like data) inputs, and finding that they are using its return value as a function pointer.

We noticed that the mw_API_resolver is called twice, 1st param of the is the same which indicated that's the hash DLL, 2nd param is different which indicated that's the hash API.

anlysis if mw_API_resolver:

In sub_687564:
the malware uses BEP to get the loaded modules, The BaseDllName is hashed by crc32_hashing then XORed against the hard-coded key.
If not matcing the required DLL base address, repeate this operation again.

In sub_6867C8:
takes two params, one of them is the returned DLL BaseAddress from sub_687564, this function is using those paras to return the API address in order to be used by Dridex, 
the e_lfanew field at offset 0X3C, offset 0X78 field of Data Directory 0X3C + 0X78 = 0X160 from the beginning of the DLL, 

## VEH
Before calling mw_API_resolver. In sub_687980, adding a new customized Exception Handler using RtlAddVectoredExceptionHandler API, which accepts an _EXCEPTION_POINTERS arguemnt. This customized exception handler will adjust the thread stack and EIP register, in order to alter the process flow to the previously resolved API address (via the ret instruction).

After calling the mw_API_Resolver function, EAX contains the address of the resolved API then traps the debugger-generates an EXCEPTION_BREAKPOINT- using int 3 instruction 

## Decrypt the strings 
decrypt all the embedded strings stored on the .rdata section in chunks. using capa tool to detect the encryption algorithm which is RC4 which used at sub_69E5D0. Xref to sub_69E5D0, at sub_687B30 we will get the length  of the key is 40 bytes 

## C2 config
look for networking functions being called. From Xrefs to mw_API_Resolver, we find sub_6A3370 and sub_6A3820 